<!DOCTYPE html>
<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
	<script src="local.js"></script>
	<script src="api_key.js"></script>
</head>
<body>
	
		<script id="mupcss" type="text/javascript" charset="utf-8">
			// Dynamic variables in CSS via JavaScript
			// Default Variables
			var	MUPCSS_PBACKGROUND = '#fbe590',
					MUPCSS_PTEXT = '#000',
					MUPCSS_SBACKGROUND = '#fff',
					MUPCSS_STEXT = '#444',
					MUPCSS_LINK = '#776004';
			
			function get_css() {
				var the_css = '\
				.mup-widget {\
					font-family: "lucida grande", lucida, tahoma, helvetica, arial, sans-serif !important;\
					font-size: 12px;\
				}\
				#mup-widget-1 .mup-doc,\
				#mup-widget-1 .mup-hd a,\
				#mup-widget-1 h3,\
				#mup-widget-1 h4 {\
					background: MUPCSS_PBACKGROUND;\
					color: MUPCSS_PTEXT;\
				}\
				#mup-widget-1 .mup-doc {\
					border-radius: 5px;\
					-moz-border-radius: 5px;\
					-webkit-border-radius: 5px;\
					width: 250px;\
				}\
				#mup-widget-1 .mup-hd {\
					padding: 10px 8px;\
					overflow: hidden;\
				}\
				.mup-widget h3,\
				.mup-widget h4,\
				.mup-widget p {\
					line-height: 1.2 !important;\
					margin: 0px !important;\
					padding: 0px !important;\
				}\
				#mup-widget-1 h3 {\
					font-size: 15px;\
					font-weight: normal;\
				}\
				#mup-widget-1 h4 {\
					font-size: 13px;\
					font-weight: normal;\
				}\
				#mup-widget .mup-bd,\
				#mup-widget .mup-timeline,\
				#mup-widget .mup-bd p {\
					color: MUPCSS_STEXT;\
				}\
				.mup-bd {\
					padding: 0 1px;\
				}\
				#mup-widget-1 .mup-timeline {\
					background: MUPCSS_SBACKGROUND;\
				}\
				a,\
				a:active,\
				a:visited,\
				a:hover {\
					color: MUPCSS_LINK;\
					text-decoration: none;\
				}\
				.mup-timeline {\
					list-style: none;\
					padding: 0;\
					margin: 0;\
					height: 300px;\
					overflow-y: auto;\
				}\
				.mup-timeline > li {\
					position: relative;\
					border-top-color: #DDD;\
					border-top-style: dotted;\
					border-top-width: 1px;\
					padding: 6px 8px;\
				}\
				.mup_everywhere_bare_stats-body_when,\
				.mup_everywhere_bare_stats-body_what {\
					\
				}\
				.mup_everywhere_bare_stats-body_time {\
					font-size: 9px;\
				}\
				.mup_everywhere_bare_stats-body_comment {\
					word-wrap: break-word;\
				}\
				.mup_everywhere_bare_stats-body_author {\
					\
				}\
				.mup-ft {\
					//border-top-color: #DDD;\
					//border-top-style: solid;\
					//border-top-width: 1px;\
				}\
				.mup-ft .mup-getwdgt {\
					padding: 6px 8px;\
					font-size: 8px;\
					text-align: center;\
					border-top-color: #F2F2F2;\
					border-top-style: solid;\
					border-top-width: 1px;\
				}\
				.mup-ft .mup-logo {\
					padding: 6px 8px 2px 8px;\
				}\
				';

				return the_css;
			}
			
			function write_css() {
				var js2css = get_css();
				
				// Replace variables with code
				js2css = js2css.replace(/MUPCSS_PBACKGROUND/g, MUPCSS_PBACKGROUND);
				js2css = js2css.replace(/MUPCSS_PTEXT/g, MUPCSS_PTEXT);
				js2css = js2css.replace(/MUPCSS_SBACKGROUND/g, MUPCSS_SBACKGROUND);
				js2css = js2css.replace(/MUPCSS_STEXT/g, MUPCSS_STEXT);
				js2css = js2css.replace(/MUPCSS_LINK/g, MUPCSS_LINK);
				
				// Write it
				document.write('<style type="text/css" media="screen">'+ js2css +'</style>');
			}
			
			write_css();
		</script>
		<script id="config" type="text/javascript" charset="utf-8">
		  var $parameters = {
		    urlname: "etsy-craft-party",
		    width: 300,
		    height: 400,
		    _name: "Everywhere Mashup",
		    _description: "Shows past meetups and aggregates tagged content from other services."
		  };
		  var $queries = {
		    containers: function() { 
		      return api_call("/ew/containers", {urlname: $parameters.urlname, fields: "meetup_count,past_meetup_count,member_count,geo_ip"});
		    },
		    events: function() { 
		      return api_call("/ew/events", {status: "upcoming", order: "time", urlname: $parameters.urlname, lat: $parameters.lat, lon: $parameters.lon, radius: "25.0", fields: "rsvp_count"});
		    },
				comments: function() { 
					return api_call("/ew/comments", {urlname: $parameters.urlname, page: '50'});
				}
		  };
		</script>
		<script type="text/javascript" charset="utf-8">
		with_jquery(function($) {
			// Set global variables
			var resultCount = 0;
			
			// Functions
			function onload() {
				$('body').append('<div id="mup-widget-1" class="mup-widget"><div class="mup-doc"></div></div>');
			}
			onload();
			
			function numberFormat(nStr){
			  nStr += '';
			  x = nStr.split('.');
			  x1 = x[0];
			  x2 = x.length > 1 ? '.' + x[1] : '';
			  var rgx = /(\d+)(\d{3})/;
			  while (rgx.test(x1))
			    x1 = x1.replace(rgx, '$1' + ',' + '$2');
			  return x1 + x2;
			}
			
			function getFormattedDate( millis ) {
				var date = new Date( millis );
				
				function addLeadingZero ( num ) {
					if ( num < 10 ) {
						var day = '0' + num;
					} else {
						return num;
					}
					return day;
				}
				
				function getTwoDigitYear ( yr ) {
					var year = yr.substring(2,4);
					return year;
				}
				
				function getFullMonth ( mo ) {
					switch ( mo ) {
						case 0:
					  		return ("JAN");
						case 1:
							return ("FEB");		
						case 2:
					  		return ("MAR");
						case 3:
							return ("APR");
						case 4:
							return ("MAY");
						case 5:
							return ("JUN");
						case 6:
							return ("JUL");
						case 7:
							return ("AUG");
						case 8:
							return ("SEP");
						case 9:
							return ("OCT");
						case 10:
							return ("NOV");
						case 11:
							return ("DEC");
						default:
							return ("Undef");
					}
				}
				
				var formattedTime = addLeadingZero( date.getDate() ) + ' ' + getFullMonth( date.getMonth() ) + ' ' + getTwoDigitYear( date.getFullYear().toString() );
				return formattedTime;
			}
			
			function getFormattedTime( millis ) {
				var time = new Date( millis );
				var hours = time.getHours();
				var min = time.getMinutes();
				var ampm = '';
				
				if( min < 10 ) {
					min = '0' + min;
				}
				if ( hours > 11 ) {
					if ( hours > 12 ) {
						hours = hours - 12;
					}
					ampm = 'PM';
				} else {
					ampm = 'AM'
				}
				var formattedTime = hours + ':' + min + ' ' + ampm;
				return formattedTime;
			}
			
			function getTimeAgo( millis ) {
				var now = new Date();
				var post = new Date( millis );
				var diff = now.getTime() - post.getTime();
				var oneHour = 3600000;
				var daysAgo = Math.floor( diff / oneHour / 24 );
				var hoursAgo = Math.floor( diff / oneHour );
				var output = '';
				
				if ( daysAgo >= 1 ) {
					return getFormattedTime( millis ) + ' ' + getFormattedDate( millis );
					//return daysAgo + ' day ago';
				//}  else if ( daysAgo > 1 ) {
				// 					return daysAgo + ' days ago';
				} else {
					// Hours ago
					if ( hoursAgo < 1 ) {
						return 'just a moment ago';
					} else if ( hoursAgo == 1) {
						return 'about ' + hoursAgo + ' hour ago';
					} else {
						return 'about ' + hoursAgo + ' hours ago';
					}
				}
				
			}
			
			function getFormattedCity( city, state ) {
				var geo = city + ', ' + state;
				return geo;
			}
			
			function getFormattedVenue( venue ) {
				if ( venue != null ) {
					return venue;
				} else {
					return 'Venue TBD';
				}
			}
			
			function addLink( content, link ) {
				return '<a href="' + link + '">' + content + '</a>';
			}
			
			$.getJSON($queries.containers(), function(data) {

		    //$("#mup_everywhere_bare_stats").width($parameters.width);
				//$("#mup_everywhere_bare_stats").height($parameters.height);
		    if (data.status && data.status.match(/^200/) == null) {
		       alert(data.status + ": " + data.details);
		    } else {
		      var container = data.results[0];
					// My code here.
					
					// Push lat/lon into event api call
					$parameters.lon = data.meta.geo_ip.lon;
					$parameters.lat = data.meta.geo_ip.lat;
					
					var total_meetup_count = container.meetup_count + container.past_meetup_count;
					
					$(document).ready(function() {
						$('.mup-doc').append(
							'<div class="mup-hd">\n' +
								'<h3>' + addLink( numberFormat(total_meetup_count) + ' ' + container.name + ' Meetups', container.meetup_url )+ '</h3>\n' +
								'<h4>' + addLink( numberFormat(container.member_count) + ' people', container.meetup_url ) + '</h4>\n' +
							'</div>'
							);
					});
					
		      $.getJSON($queries.comments(), function(data) {
		        if (data.status && data.status.match(/^200/) == null) {
		          alert(data.status + ": " + data.details);
		        } else {
		          resultCount = parseInt(data.meta.total_count);
							$('.mup-doc').append('<div class="mup-bd"><ul class="mup-timeline"></ul></div>');
							
		          $.each(data.results, function(i, com) {
		            if ( i < resultCount ) {
		              // My code here.
		
									$(document).ready(function() {
										$('.mup-timeline').append( 
											'<li>' +
												'<div class="mup_everywhere_bare_stats-body_what">' +
													'<span class="mup_everywhere_bare_stats-body_comment">&ldquo;' + com.comment + '&rdquo;</span>' +
													'<span class="mup_everywhere_bare_stats-body_author"> -<em>' + com.member.name + '</em></span>' +
												'</div>' +
												'<div class="mup_everywhere_bare_stats-body_when">' +
													'<span class="mup_everywhere_bare_stats-body_time">' + getTimeAgo( com.time ) + '</span>' +
												'</div>' +
											'</li>' );
									});
		            }
		          });
							$(document).ready(function() {
								$('.mup-doc').append('<div class="mup-ft"><div class="mup-logo"><img src="http://img1.meetupstatic.com/84869143793177372874/img/birddog/everywhere_widget.png"></div><div class="mup-getwdgt">' + addLink( 'ADD THIS TO YOUR SITE', container.meetup_url ) + '</div></div>')
							});
		        }
		      });
		    }
		  });
		});
		</script>
</body>
</html>